---
import Layout from "../layouts/Layout.astro";
import GateAnimation from "../components/GateAnimation.astro";
import Hero from "../components/Hero.astro";
import ParentsSection from "../components/ParentsSection.astro";
import EventDetails from "../components/EventDetails.astro";
import Timeline from "../components/Timeline.astro";
import GratitudeApology from "../components/GratitudeApology.astro";
import Footer from "../components/Footer.astro";
---

<Layout
  title="Pheakdey & Dinin Wedding Invitation - ភក្តី និង ឌីនីន"
  description="Join us in celebrating the wedding of Lmut Pheakdey & Srorn Dinin on February 27, 2026 at Koh Dach Village, Phnom Penh"
>
  <!-- Gate Animation -->
  <GateAnimation />

  <!-- Main Content -->
  <main id="main-content" class="opacity-0">
    <!-- Hero Section -->
    <div class="section-animate">
      <Hero />
    </div>

    <!-- Parents Section -->
    <div class="section-animate">
      <ParentsSection />
    </div>

    <!-- Event Details Section -->
    <div class="section-animate">
      <EventDetails />
    </div>

    <!-- Timeline Section -->
    <div class="section-animate">
      <Timeline />
    </div>

    <!-- Gratitude & Apology Section -->
    <div class="section-animate">
      <GratitudeApology />
    </div>

    <!-- Footer -->
    <div class="section-animate">
      <Footer />
    </div>
  </main>

</Layout>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // Listen for gate opened event
  document.addEventListener('gateOpened', () => {
    // Animate main content entrance
    const mainContent = document.getElementById("main-content");
    if (mainContent) {
      gsap.to(mainContent, {
        opacity: 1,
        duration: 1,
        ease: "power2.out",
        onComplete: () => {
          // After main content fades in, animate each section
          animateSections();
        }
      });
    }
  });

  // Animate sections sequentially
  function animateSections() {
    const sections = document.querySelectorAll('.section-animate');
    
    sections.forEach((section, index) => {
      gsap.fromTo(section,
        {
          opacity: 0,
          y: 60,
          scale: 0.95
        },
        {
          opacity: 1,
          y: 0,
          scale: 1,
          duration: 1,
          delay: index * 0.15,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            end: 'top 20%',
            toggleActions: 'play none none none'
          }
        }
      );
    });
  }

  // Smooth scroll for internal links
  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener("click", function (this: HTMLAnchorElement, e) {
      e.preventDefault();
      const targetId = this.getAttribute("href");
      if (targetId) {
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }
    });
  });

  // Parallax effect on scroll
  window.addEventListener("scroll", () => {
    const scrolled = window.pageYOffset;
    const parallaxElements = document.querySelectorAll("[data-parallax]");

    parallaxElements.forEach((element) => {
      const speed = parseFloat(
        (element as HTMLElement).dataset.parallax || "0.5",
      );
      const yPos = -(scrolled * speed);
      (element as HTMLElement).style.transform = `translateY(${yPos}px)`;
    });
  });

  // Add intersection observer for fade-in animations
  const observerOptions = {
    threshold: 0.1,
    rootMargin: "0px 0px -50px 0px",
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
      }
    });
  }, observerOptions);

  // Observe all fade-in elements
  document.querySelectorAll(".fade-in").forEach((element) => {
    observer.observe(element);
  });

  // Preload images for better performance
  const preloadImages = () => {
    const images = document.querySelectorAll("img[data-src]");
    images.forEach((img) => {
      const src = img.getAttribute("data-src");
      if (src) {
        img.setAttribute("src", src);
      }
    });
  };

  if (document.readyState === "complete") {
    preloadImages();
  } else {
    window.addEventListener("load", preloadImages);
  }
</script>

<style>
  /* Additional custom animations */
  @keyframes float {
    0%,
    100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-20px);
    }
  }

  .animate-float {
    animation: float 3s ease-in-out infinite;
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
  }

  ::-webkit-scrollbar-track {
    background: #fff8dc;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #ffd700, #d4af37);
    border-radius: 6px;
    border: 2px solid #fff8dc;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #d4af37, #b8860b);
  }

  /* Ensure main content is hidden initially */
  #main-content {
    opacity: 0;
  }

  /* Section animation initial state */
  .section-animate {
    opacity: 0;
    transform: translateY(60px) scale(0.95);
  }

  /* Add subtle entrance effects */
  @keyframes shimmer {
    0% {
      background-position: -1000px 0;
    }
    100% {
      background-position: 1000px 0;
    }
  }
</style>
